@page "/"
@using System.Text.Json
@using JoArtClassLib.Art
@using Microsoft.IdentityModel.Tokens
@inject HttpClient Http

<PageTitle>Home</PageTitle>

@if (!string.IsNullOrEmpty(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

<div class="hero-image">
    @for (var i = 0; i < slides.Count; i++)
    {
        var img = slides[i];
        <div class="slide @(i == currentIndex ? "active" : "")">
            <picture>
                <!-- Mobil: Preview -->
                <source media="(max-width: 576px)"    srcset="@img.PreviewUrl" />
                <!-- Tablet / smaller screens: also Preview -->
                <source media="(max-width: 992px)"    srcset="@img.PreviewUrl" />
                <!-- Desktop: FullView -->
                <source media="(min-width: 993px)"    srcset="@img.FullViewUrl" />

                <!-- Fallback / older browser: thumbnail -->
                <img
                    src="@img.ThumbnailUrl"
                    class="slide-image"
                    alt="Hero slide @(i+1)"
                    loading="lazy" />
            </picture>
        </div>
    }
</div>



@code{

    private List<ImageResponse> slides = [];
    private string? ErrorMessage;
    private int currentIndex;
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            slides = await Http.GetFromJsonAsync<List<ImageResponse>>("/api/PublicGallery/homePageRotation")
                     ?? new List<ImageResponse>();
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Could not load rotation images: {ex.Message}";
        }

        if (slides.Count > 1)
        {
            _timer = new System.Threading.Timer(_ =>
            {
                currentIndex = (currentIndex + 1) % slides.Count;
                InvokeAsync(StateHasChanged);
            }, null, 5000, 5000);
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

}